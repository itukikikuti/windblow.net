---
layout: post
title: Direct3D 11で三角形を描画する
category: DirectX11
date: 2018-11-05 00:00:01
---

やっと描画できるようになったので三角形を描画してみましょう。しかも虹色の三角形です。まず三角形の形を決めないといけませんね。形というのは頂点で表すので頂点の構造体を作ります。

``` cpp
struct Vertex
{
    DirectX::XMFLOAT3 position;
    DirectX::XMFLOAT3 color;

    Vertex(DirectX::XMFLOAT3 position, DirectX::XMFLOAT3 color)
        : position(position), color(color)
    {
    }
};
```

頂点は座標と色の情報を持っています。さっき作ったインプットレイアウトとそっくり同じにしないといけません。この頂点を使って三角形を作ります。

``` cpp
    std::vector<Vertex> vertices;
    vertices.push_back(Vertex(DirectX::XMFLOAT3(0.0f, 1.0f, 0.0f), DirectX::XMFLOAT3(1.0f, 1.0f, 0.0f)));
    vertices.push_back(Vertex(DirectX::XMFLOAT3(1.0f, -1.0f, 0.0f), DirectX::XMFLOAT3(0.0f, 1.0f, 1.0f)));
    vertices.push_back(Vertex(DirectX::XMFLOAT3(-1.0f, -1.0f, 0.0f), DirectX::XMFLOAT3(1.0f, 0.0f, 1.0f)));
```

頂点を3つ作れば三角形になりますよね。直感的ですね。座標は上、右下、左下という感じにしていて、色はイエロー、シアン、マゼンタにしてます。これを描画するには頂点バッファというものを使います。ID3D11Device::CreateBuffer関数で頂点バッファを作って、ID3D11DeviceContext::IASetVertexBuffers関数で設定して、ID3D11DeviceContext::Drawで描画します。

``` cpp
    D3D11_BUFFER_DESC vertexBufferDesc = {};
    vertexBufferDesc.ByteWidth = sizeof(Vertex) * (UINT)vertices.size();
    vertexBufferDesc.Usage = D3D11_USAGE_DEFAULT;
    vertexBufferDesc.BindFlags = D3D11_BIND_VERTEX_BUFFER;

    D3D11_SUBRESOURCE_DATA vertexSubresourceData = {};
    vertexSubresourceData.pSysMem = vertices.data();

    Microsoft::WRL::ComPtr<ID3D11Buffer> vertexBuffer;
    Graphics::GetDevice().CreateBuffer(&vertexBufferDesc, &vertexSubresourceData, vertexBuffer.GetAddressOf());
    
    UINT stride = sizeof(Vertex);
    UINT offset = 0;
    Graphics::GetContext().IASetVertexBuffers(0, 1, vertexBuffer.GetAddressOf(), &stride, &offset);

    Graphics::GetContext().IASetPrimitiveTopology(D3D11_PRIMITIVE_TOPOLOGY_TRIANGLELIST);

    Graphics::GetContext().Draw((UINT)vertices.size(), 0);
```

こんな感じです。ID3D11DeviceContext::IASetPrimitiveTopologyというものがありますが、これは描画方法を三角形にしています。描画方法には点とか線とか三角形とか連なった三角形とかいろいろあるんですが、今回はD3D11_PRIMITIVE_TOPOLOGY_TRIANGLELISTにして三角形と解釈させています。詳しくは「D3D11_PRIMITIVE_TOPOLOGY」でググってください。

では、これをクラスにしてみましょう。Mesh.hppとMesh.cppというファイルを作ってください。

<small>Mesh.hpp</small>
``` cpp
#pragma once
#include <vector>
#include <d3d11.h>
#include <DirectXMath.h>
#include <wrl.h>
#include "Shader.hpp"

struct Vertex
{
    DirectX::XMFLOAT3 position;
    DirectX::XMFLOAT3 color;

    Vertex(DirectX::XMFLOAT3 position, DirectX::XMFLOAT3 color)
        : position(position), color(color)
    {
    }
};

class Mesh
{
public:
    std::vector<Vertex> vertices;
    Shader shader = Shader::GetDefault();

    Mesh();
    void Draw();

private:
    Microsoft::WRL::ComPtr<ID3D11Buffer> vertexBuffer;
};
```

<small>Mesh.cpp</small>
``` cpp
#include "Graphics.hpp"
#include "Mesh.hpp"

Mesh::Mesh()
{
    vertices.push_back(Vertex(DirectX::XMFLOAT3(0.0f, 1.0f, 0.0f), DirectX::XMFLOAT3(1.0f, 1.0f, 0.0f)));
    vertices.push_back(Vertex(DirectX::XMFLOAT3(1.0f, -1.0f, 0.0f), DirectX::XMFLOAT3(0.0f, 1.0f, 1.0f)));
    vertices.push_back(Vertex(DirectX::XMFLOAT3(-1.0f, -1.0f, 0.0f), DirectX::XMFLOAT3(1.0f, 0.0f, 1.0f)));

    D3D11_BUFFER_DESC vertexBufferDesc = {};
    vertexBufferDesc.ByteWidth = sizeof(Vertex) * (UINT)vertices.size();
    vertexBufferDesc.Usage = D3D11_USAGE_DEFAULT;
    vertexBufferDesc.BindFlags = D3D11_BIND_VERTEX_BUFFER;

    D3D11_SUBRESOURCE_DATA vertexSubresourceData = {};
    vertexSubresourceData.pSysMem = vertices.data();

    Graphics::GetDevice().CreateBuffer(&vertexBufferDesc, &vertexSubresourceData, vertexBuffer.GetAddressOf());
}

void Mesh::Draw()
{
    shader.Attach();

    UINT stride = sizeof(Vertex);
    UINT offset = 0;
    Graphics::GetContext().IASetVertexBuffers(0, 1, vertexBuffer.GetAddressOf(), &stride, &offset);

    Graphics::GetContext().IASetPrimitiveTopology(D3D11_PRIMITIVE_TOPOLOGY_TRIANGLELIST);

    Graphics::GetContext().Draw((UINT)vertices.size(), 0);
}
```

<small>Source.cpp</small>
``` cpp
#include "Window.hpp"
#include "Graphics.hpp"

#include "Shader.hpp"
#include "Camera.hpp"
#include "Mesh.hpp"

void Initialize()
{
    Window::Initialize();
    Graphics::Initialize();
}

bool Refresh()
{
    Graphics::Update();
    return Window::Update();
}

int APIENTRY wWinMain(HINSTANCE, HINSTANCE, LPWSTR, int)
{
    Initialize();

    Camera camera;
    Mesh mesh;

    while (Refresh())
    {
        camera.Start();
        
        mesh.Draw();

        camera.Stop();
    }

    return 0;
}
```

こんな感じでクラスにしました。Mesh::Draw関数の最初でシェーダを使ってます。ちなみにカメラの背景色を白にしてます。Camera::Start関数のclearColorの部分を`{ 1.0f, 1.0f, 1.0f, 1.0f }`にすれば白くなります。ダウンロードしたい人はGitHubに[サンプルリポジトリ](https://github.com/itukikikuti/DirectX11Sample)があるので、ぜひダウンロードしてください。
