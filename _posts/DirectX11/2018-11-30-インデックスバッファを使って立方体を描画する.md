---
layout: post
title: インデックスバッファを使って立方体を描画する
category: DirectX11
date: 2018-11-30 00:00:00
---

Meshクラスにいろいろ追加します。

``` cpp
class Mesh
{
public:
    void Create(const std::vector<Vertex>& vertices, const std::vector<UINT>& indices); // publicに追加
private:
    Microsoft::WRL::ComPtr<ID3D11Buffer> indexBuffer; // privateに追加
};
```

コンストラクタに書いてある頂点バッファを作る処理をMesh::Create関数に移します。

``` cpp
Mesh::Mesh()
{
    position = DirectX::XMFLOAT3(0.0f, 0.0f, 0.0f);
    rotation = DirectX::XMFLOAT3(0.0f, 0.0f, 0.0f);
    scale = DirectX::XMFLOAT3(1.0f, 1.0f, 1.0f);

    std::vector<Vertex> vertices
    {
        Vertex(DirectX::XMFLOAT3(0.0f, 1.0f, 0.0f), DirectX::XMFLOAT3(1.0f, 1.0f, 0.0f)),
        Vertex(DirectX::XMFLOAT3(1.0f, -1.0f, 0.0f), DirectX::XMFLOAT3(0.0f, 1.0f, 1.0f)),
        Vertex(DirectX::XMFLOAT3(-1.0f, -1.0f, 0.0f), DirectX::XMFLOAT3(1.0f, 0.0f, 1.0f))
    };

    std::vector<UINT> indices;

    Create(vertices, indices);
}

void Mesh::Create(const std::vector<Vertex>& vertices, const std::vector<UINT>& indices)
{
    vertexSize = (UINT)vertices.size();

    D3D11_BUFFER_DESC vertexBufferDesc = {};
    vertexBufferDesc.ByteWidth = sizeof(Vertex) * (UINT)vertices.size();
    vertexBufferDesc.Usage = D3D11_USAGE_DEFAULT;
    vertexBufferDesc.BindFlags = D3D11_BIND_VERTEX_BUFFER;

    D3D11_SUBRESOURCE_DATA vertexSubresourceData = {};
    vertexSubresourceData.pSysMem = vertices.data();

    Graphics::GetDevice().CreateBuffer(&vertexBufferDesc, &vertexSubresourceData, vertexBuffer.GetAddressOf());
}
```

Mesh::Create関数にインデックスバッファを作る処理を追加します。

``` cpp
void Mesh::Create(const std::vector<Vertex>& vertices, const std::vector<UINT>& indices)
{
    vertexSize = (UINT)indices.size();

    vertexBuffer.Reset();
    D3D11_BUFFER_DESC vertexBufferDesc = {};
    vertexBufferDesc.ByteWidth = sizeof(Vertex) * (UINT)vertices.size();
    vertexBufferDesc.Usage = D3D11_USAGE_DEFAULT;
    vertexBufferDesc.BindFlags = D3D11_BIND_VERTEX_BUFFER;

    D3D11_SUBRESOURCE_DATA vertexSubresourceData = {};
    vertexSubresourceData.pSysMem = vertices.data();

    Graphics::GetDevice().CreateBuffer(&vertexBufferDesc, &vertexSubresourceData, vertexBuffer.GetAddressOf());

    indexBuffer.Reset();
    D3D11_BUFFER_DESC indexBufferDesc = {};
    indexBufferDesc.ByteWidth = sizeof(UINT) * (UINT)indices.size();
    indexBufferDesc.Usage = D3D11_USAGE_DEFAULT;
    indexBufferDesc.BindFlags = D3D11_BIND_INDEX_BUFFER;

    D3D11_SUBRESOURCE_DATA indexSubresourceData = {};
    indexSubresourceData.pSysMem = indices.data();

    Graphics::GetDevice().CreateBuffer(&indexBufferDesc, &indexSubresourceData, indexBuffer.GetAddressOf());
}
```

Mesh::Draw関数をちょっと変えます。

``` cpp
void Mesh::Draw()
{
    shaderData.Get().modelMatrix = DirectX::XMMatrixTranspose(
        DirectX::XMMatrixScaling(scale.x, scale.y, scale.z) *
        DirectX::XMMatrixRotationRollPitchYaw(
            DirectX::XMConvertToRadians(rotation.x),
            DirectX::XMConvertToRadians(rotation.y),
            DirectX::XMConvertToRadians(rotation.z)
        ) *
        DirectX::XMMatrixTranslation(position.x, position.y, position.z)
    );

    shaderData.Attach(0);

    shader.Attach();

    UINT stride = sizeof(Vertex);
    UINT offset = 0;
    Graphics::GetContext().IASetVertexBuffers(0, 1, vertexBuffer.GetAddressOf(), &stride, &offset);
    Graphics::GetContext().IASetIndexBuffer(indexBuffer.Get(), DXGI_FORMAT_R32_UINT, 0); // 追加

    Graphics::GetContext().IASetPrimitiveTopology(D3D11_PRIMITIVE_TOPOLOGY_TRIANGLELIST);

    Graphics::GetContext().DrawIndexed(vertexSize, 0, 0); // 変更
}
```

コンストラクタにあるindicesという変数にも値を入れてます。

``` cpp
    std::vector<UINT> indices
    {
        0, 1, 2
    };
```

三角形を作る処理をMesh::CreateTriangle関数にまとめます。

``` cpp
class Mesh
{
public:
    void CreateTriangle(float size); // 追加
};

```

``` cpp
Mesh::Mesh()
{
    position = DirectX::XMFLOAT3(0.0f, 0.0f, 0.0f);
    rotation = DirectX::XMFLOAT3(0.0f, 0.0f, 0.0f);
    scale = DirectX::XMFLOAT3(1.0f, 1.0f, 1.0f);

    CreateTriangle(1.0f);
}

void Mesh::CreateTriangle(float size)
{
    size *= 0.5f;

    std::vector<Vertex> vertices
    {
        Vertex(DirectX::XMFLOAT3(0.0f, size, 0.0f), DirectX::XMFLOAT3(1.0f, 1.0f, 0.0f)),
        Vertex(DirectX::XMFLOAT3(size, -size, 0.0f), DirectX::XMFLOAT3(0.0f, 1.0f, 1.0f)),
        Vertex(DirectX::XMFLOAT3(-size, -size, 0.0f), DirectX::XMFLOAT3(1.0f, 0.0f, 1.0f))
    };

    std::vector<UINT> indices
    {
        0, 1, 2
    };

    Create(vertices, indices);
}
```

コンストラクタがかなりスッキリしました。三角形の大きさも変えられるようにしました。1.0fを指定すると、今までよりも小さいです。

平面を作ってみましょう。

``` cpp
class Mesh
{
public:
    void CreatePlane(DirectX::XMFLOAT2 size); // 追加
};
```

``` cpp
void Mesh::CreatePlane(DirectX::XMFLOAT2 size)
{
    size.x *= 0.5f;
    size.y *= 0.5f;

    std::vector<Vertex> vertices
    {
        Vertex(DirectX::XMFLOAT3(-size.x, size.y, 0.0f), DirectX::XMFLOAT3(1.0f, 1.0f, 0.0f)),
        Vertex(DirectX::XMFLOAT3(size.x, size.y, 0.0f), DirectX::XMFLOAT3(0.0f, 1.0f, 1.0f)),
        Vertex(DirectX::XMFLOAT3(-size.x, -size.y, 0.0f), DirectX::XMFLOAT3(1.0f, 0.0f, 1.0f)),
        Vertex(DirectX::XMFLOAT3(size.x, -size.y, 0.0f), DirectX::XMFLOAT3(1.0f, 1.0f, 1.0f))
    };

    std::vector<UINT> indices
    {
        0, 1, 2,
        3, 2, 1
    };

    Create(vertices, indices);
}
```

``` cpp
int APIENTRY wWinMain(HINSTANCE, HINSTANCE, LPWSTR, int)
{
    Initialize();

    Camera camera;
    camera.position = DirectX::XMFLOAT3(0.0f, 2.0f, -2.0f);
    camera.rotation = DirectX::XMFLOAT3(45.0f, 0.0f, 0.0f);

    Mesh mesh;
    mesh.CreatePlane(DirectX::XMFLOAT2(1.0f, 1.0f));

    float angle = 0.0f;

    while (Refresh())
    {
        camera.Start();
        
        angle += 1.0f;

        mesh.rotation.y = angle;
        mesh.Draw();

        camera.Stop();
    }

    return 0;
}
```

これで実行すると平面が回転します。

次は立方体を作ってみましょう。

``` cpp
void Mesh::CreateCube(DirectX::XMFLOAT3 size)
{
    size.x *= 0.5f;
    size.y *= 0.5f;
    size.z *= 0.5f;

    std::vector<Vertex> vertices
    {
        // 前
        Vertex(DirectX::XMFLOAT3(-size.x, size.y, -size.z), DirectX::XMFLOAT3(1.0f, 1.0f, 0.0f)),
        Vertex(DirectX::XMFLOAT3(size.x, size.y, -size.z), DirectX::XMFLOAT3(0.0f, 1.0f, 1.0f)),
        Vertex(DirectX::XMFLOAT3(-size.x, -size.y, -size.z), DirectX::XMFLOAT3(1.0f, 0.0f, 1.0f)),
        Vertex(DirectX::XMFLOAT3(size.x, -size.y, -size.z), DirectX::XMFLOAT3(1.0f, 1.0f, 1.0f)),

        // 後
        Vertex(DirectX::XMFLOAT3(size.x, size.y, size.z), DirectX::XMFLOAT3(1.0f, 1.0f, 0.0f)),
        Vertex(DirectX::XMFLOAT3(-size.x, size.y, size.z), DirectX::XMFLOAT3(0.0f, 1.0f, 1.0f)),
        Vertex(DirectX::XMFLOAT3(size.x, -size.y, size.z), DirectX::XMFLOAT3(1.0f, 0.0f, 1.0f)),
        Vertex(DirectX::XMFLOAT3(-size.x, -size.y, size.z), DirectX::XMFLOAT3(1.0f, 1.0f, 1.0f)),

        // 左
        Vertex(DirectX::XMFLOAT3(size.x, size.y, -size.z), DirectX::XMFLOAT3(1.0f, 1.0f, 0.0f)),
        Vertex(DirectX::XMFLOAT3(size.x, size.y, size.z), DirectX::XMFLOAT3(0.0f, 1.0f, 1.0f)),
        Vertex(DirectX::XMFLOAT3(size.x, -size.y, -size.z), DirectX::XMFLOAT3(1.0f, 0.0f, 1.0f)),
        Vertex(DirectX::XMFLOAT3(size.x, -size.y, size.z), DirectX::XMFLOAT3(1.0f, 1.0f, 1.0f)),

        // 右
        Vertex(DirectX::XMFLOAT3(-size.x, size.y, size.z), DirectX::XMFLOAT3(1.0f, 1.0f, 0.0f)),
        Vertex(DirectX::XMFLOAT3(-size.x, size.y, -size.z), DirectX::XMFLOAT3(0.0f, 1.0f, 1.0f)),
        Vertex(DirectX::XMFLOAT3(-size.x, -size.y, size.z), DirectX::XMFLOAT3(1.0f, 0.0f, 1.0f)),
        Vertex(DirectX::XMFLOAT3(-size.x, -size.y, -size.z), DirectX::XMFLOAT3(1.0f, 1.0f, 1.0f)),

        // 上
        Vertex(DirectX::XMFLOAT3(-size.x, size.y, size.z), DirectX::XMFLOAT3(1.0f, 1.0f, 0.0f)),
        Vertex(DirectX::XMFLOAT3(size.x, size.y, size.z), DirectX::XMFLOAT3(0.0f, 1.0f, 1.0f)),
        Vertex(DirectX::XMFLOAT3(-size.x, size.y, -size.z), DirectX::XMFLOAT3(1.0f, 0.0f, 1.0f)),
        Vertex(DirectX::XMFLOAT3(size.x, size.y, -size.z), DirectX::XMFLOAT3(1.0f, 1.0f, 1.0f)),

        // 下
        Vertex(DirectX::XMFLOAT3(-size.x, -size.y, -size.z), DirectX::XMFLOAT3(1.0f, 1.0f, 0.0f)),
        Vertex(DirectX::XMFLOAT3(size.x, -size.y, -size.z), DirectX::XMFLOAT3(0.0f, 1.0f, 1.0f)),
        Vertex(DirectX::XMFLOAT3(-size.x, -size.y, size.z), DirectX::XMFLOAT3(1.0f, 0.0f, 1.0f)),
        Vertex(DirectX::XMFLOAT3(size.x, -size.y, size.z), DirectX::XMFLOAT3(1.0f, 1.0f, 1.0f))
    };

    std::vector<UINT> indices
    {
        // 前
        0, 1, 2,
        3, 2, 1,

        // 後
        4, 5, 6,
        7, 6, 5,

        // 左
        8, 9, 10,
        11, 10, 9,

        // 右
        12, 13, 14,
        15, 14, 13,

        // 上
        16, 17, 18,
        19, 18, 17,

        // 下
        20, 21, 22,
        23, 22, 21
    };

    Create(vertices, indices);
}
```

とんでもない長さになってしまいましたね。うまくやればもっと短く出来るのでチャレンジしてみてもいいかもしれません。
